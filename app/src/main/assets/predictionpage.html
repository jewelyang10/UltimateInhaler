<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <title>Prediction</title>
    <meta name="description" content=""/>
    <meta name="author" content="magician-harry"/>

    <meta name="viewport" content="width=device-width; initial-scale=1.0"/>
    <script src="file:///android_asset/Chart.min.js"></script>

    <script type="text/javascript">
		

		
    var Calendar = function(divId) {
			//Store div id
			this.divId = divId;
			// Days of week, starting on Sunday
			this.DaysOfWeek = [
				'Sun',
				'Mon',
				'Tue',
				'Wed',
				'Thu',
				'Fri',
				'Sat'
			];
			// Months, stating on January
			this.Months = [	'January','February','March','April',
						   'May','June','July','August',
						   'September','October','November','December'];
			// Set the current month, year
			var d = new Date();
			this.CurrentMonth = d.getMonth();
			this.CurrentYear = d.getFullYear();
		};
		// Goes to next month
		Calendar.prototype.nextMonth = function() {
			if ( this.CurrentMonth == 11 ) {
				this.CurrentMonth = 0;
				this.CurrentYear = this.CurrentYear + 1;
			}
			else {
				this.CurrentMonth = this.CurrentMonth + 1;
			}
			this.showCurrent();
		};
		// Goes to previous month
		Calendar.prototype.previousMonth = function() {
			if ( this.CurrentMonth == 0 ) {
				this.CurrentMonth = 11;
				this.CurrentYear = this.CurrentYear - 1;
			}
			else {
				this.CurrentMonth = this.CurrentMonth - 1;
			}
			this.showCurrent();
		};
		// Show current month
		Calendar.prototype.showCurrent = function() {
			this.showMonth(this.CurrentYear, this.CurrentMonth);
		};
		// Show month (year, month)
		Calendar.prototype.showMonth = function(y, m) {
			var d = new Date()
				// First day of the week in the selected month
				, firstDayOfMonth = new Date(y, m, 1).getDay()
				// Last day of the selected month
				, lastDateOfMonth =  new Date(y, m+1, 0).getDate()
				// Last day of the previous month
				, lastDayOfLastMonth = m == 0 ? new Date(y-1, 11, 0).getDate() : new Date(y, m, 0).getDate();
			var html = '<table>';
			// Write selected month and year
			html += '<thead><td colspan="7">' + this.Months[m] + ' - ' + y + '</thead></tr>';
			// Write the header of the days of the week
			html += '<tr>';
			for(var i=0; i < this.DaysOfWeek.length;i++) {
				html += '<td>' + this.DaysOfWeek[i] + '</td>';
			}
			html += '</tr>';
			// Write the days
			var i=1;
			do {
				var dow = new Date(y, m, i).getDay();
				// If Sunday, start new row
				if ( dow == 0 ) {
					html += '<tr>';
				}
				// If not Sunday but first day of the month
				// it will write the last days from the previous month
				else if ( i == 1 ) {
					html += '<tr>';
					var k = lastDayOfLastMonth - firstDayOfMonth+1;
					for(var j=0; j < firstDayOfMonth; j++) {
						html += '<td class="not-current">' + k + '</td>';
						k++;
					}
				}
				// Write the current day in the loop
				html += '<td class="MonthDays">' + i + '</td>';
				// If Saturday, closes the row
				if ( dow == 6 ) {
					html += '</tr>';
				}
				// If not Saturday, but last day of the selected month
				// it will write the next few days from the next month
				else if ( i == lastDateOfMonth ) {
					var k=1;
					for(dow; dow < 6; dow++) {
						html += '<td class="not-current MonthDays">' + k + '</td>';
						k++;
					}
				}
				i++;
			}while(i <= lastDateOfMonth);
			// Closes table
			html += '</table>';
			// Write HTML to the div
			document.getElementById(this.divId).innerHTML = html;
		};
		// On Load of the window
		window.onload = function() {
			// Start calendar
			var c = new Calendar("divCalendar");
			//c.showCurrent();
			// Bind next and previous button clicks

		//onclick function waiting for buddle
			var allDays =document.getElementsByClassName("MonthDays")
			for (var i = 0; i < allDays.length; i++)
			{
				allDays[i].addEventListener("click",function(){Android.clickDate(this.innerHTML);});
			}
		}
		// Get element by id
		function getId(id) {
			return document.getElementById(id);
		}
		
		
  			

		
    </script>

    <style type="text/css">
        table {
        border-collapse: collapse;
        width: 100%;
        }
        th, td {
        text-align: left;
        padding: 8px;
        }
        tr:nth-child(even){background-color: #f2f2f2}
        td.not-current {
        color: #777777;
        }
        thead {
        color:#fff!important;
        background-color:#f44336!important;
        }
    </style>

</head>

<body>

<header>
    <h1>Prediction For Asthma</h1>
</header>
<div>
    <h2>Overall Prediction Of Danger Level In Percentage</h2>
    <h3 id="overallDiscription"></h3>
    <canvas id="overallDanger" width="100%" height="100%"></canvas>
</div>

<div>
    <h2>Contribution of Each Parameter</h2>
    <canvas id="predictionEvidence" width="100%" height="100%"></canvas>
</div>

<div>
    <h2>Long Term Prediction and History</h2>
    <canvas id="longTermPrediction" width="100%" height="100%"></canvas>
</div>

<div>
    <h2>Pollen Tendency</h2>
    <canvas id="pollenTend" width="100%" height="100%"></canvas>
</div>

<div>
    <h2>Biodiversity of Surrounding and Personal Triggering History</h2>
    <canvas id="bioCondition" width="100%" height="100%"></canvas>
</div>

<div>
    <h2>Monthly History and Review</h2>
    <div id="divCalendar" style="overflow-x:auto;">
    </div>
</div>

<footer>
    <p>
        &copy; Copyright by Olympia
    </p>
</footer>

</body>
<script type="text/javascript">
	
	//add default value in case...	
	var finalPercentage = [11,16,25,30,18];
	var overallPredictionPercentage = [25,5,70];
	var tomorrowRatio = 1.1;
	
	var xhttp = new XMLHttpRequest();
  			xhttp.onreadystatechange = function() {
    		if (this.readyState == 4 && this.status == 200) {
     			
				var responseJSON = JSON.parse(this.responseText);
				var humidity = responseJSON["query"]["results"]["channel"]["atmosphere"]["humidity"];
				var pressure = responseJSON["query"]["results"]["channel"]["atmosphere"]["pressure"] / 10;
				var temp =  responseJSON["query"]["results"]["channel"]["item"]["condition"]["temp"];
				var wind = responseJSON["query"]["results"]["channel"]["wind"]["chill"];
				var tomorrowHigh = responseJSON["query"]["results"]["channel"]["item"]["forecast"][0]["high"];
 				var tomorrowLow = responseJSON["query"]["results"]["channel"]["item"]["forecast"][0]["low"];
				var locationLatitue = responseJSON["query"]["results"]["channel"]["item"]["lat"];
				var locationLongtitue = responseJSON["query"]["results"]["channel"]["item"]["long"];
				
				
			var minMaxArray = [humidity, pressure, temp, wind];
			minMaxArray.sort();
			var preprocessingResult = new Array();
			var range = minMaxArray[3] - minMaxArray[0];
				
			minMaxArray.forEach(function(element)
								{preprocessingResult.push( (element - minMaxArray[0]) / range + 1 );});
				
			var sumStep1 =0;
			preprocessingResult.forEach(function(ele){sumStep1+=ele;});
			
			preprocessingResult.push(2 - 0.8*sumStep1);
			
			var sumStep2 =0;
			preprocessingResult.forEach(function(ele){sumStep2+=ele;});
				
			
				
			preprocessingResult.forEach(function(element,index){
				finalPercentage[index] = ( Math.ceil(element/sumStep2*100));
			});
				
			
			var sumStep3 = 0;
			finalPercentage.forEach(function(elem){sumStep3+=elem;});

			var safePercentage = Math.ceil( 100 / (1+ Math.pow(  Math.E , 0 - sumStep3/100  )));
				
			var danger = Math.ceil( 90 - safePercentage);
			
			var CIrange = Math.ceil( 100 - safePercentage - danger);
				
			overallPredictionPercentage = [danger,CIrange,safePercentage];
				
			tomorrowRatio = temp / tomorrowHigh;
				
				
			
				var myLongTermPrediction = new Chart(
			document.getElementById("longTermPrediction").getContext("2d"),
											 {
    type: 'bar',
    data: {
        labels: ["Today", "Tomorrow"],
        datasets: [{
            label: 'percentage (%)',
            data: [  overallPredictionPercentage[0], Math.ceil(tomorrowRatio * overallPredictionPercentage[0])  ],
            backgroundColor: [
              
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
            ],
            borderColor: [
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
            ],
            borderWidth: 3
        }]
    },
    options: {
    legend: {
            display: false
         },
         tooltips: {
            enabled: false
         },
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:true
                }
            }]
        }
    }
});
	var pollenTendGraph = new Chart( document.getElementById("pollenTend").getContext("2d"),
									{
    type: 'line',
    data: {
    labels: ["March", "April", "May", "June", "July", "August", "September"],
    datasets: [
        {
            label: "average pollen count concentration",
            fill: true,
            lineTension: 0.2,
            backgroundColor: "rgba(75,192,192,0.4)",
            borderColor: "rgba(75,192,192,1)",
            borderCapStyle: 'butt',
            borderDash: [],
            borderDashOffset: 0.0,
            borderJoinStyle: 'miter',
            pointBorderColor: "rgba(75,192,192,1)",
            pointBackgroundColor: "#fff",
            pointBorderWidth: 1,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "rgba(75,192,192,1)",
            pointHoverBorderColor: "rgba(220,220,220,1)",
            pointHoverBorderWidth: 2,
            pointRadius: 1,
            pointHitRadius: 10,
            data:JSON.parse(Android.GetPollen()),
            spanGaps: false,
        }
    ]
},
    options: {
        scales: {
            yAxes: [{
                stacked: true
            }]
        }
    }
});
		var myRadarChart = new Chart(document.getElementById("bioCondition").getContext("2d"), {
    	type: 'radar',
    	data: {
    labels: ["Eucalyptus","Ulmus","Platanus","Acacia","Corymbia","Allocasuarina","Quercus"],
    datasets: [
        {
            label: "environmental situation in percentage",
            backgroundColor: "rgba(179,181,198,0.2)",
            borderColor: "rgba(179,181,198,1)",
            pointBackgroundColor: "rgba(179,181,198,1)",
            pointBorderColor: "#fff",
            pointHoverBackgroundColor: "#fff",
            pointHoverBorderColor: "rgba(179,181,198,1)",
            data: [38,14,14,11,11,7,5]
			//due to databse migration, this is a old value manually got from database
        }
    ]
},
    	     options: {
            scale: {
                reverse: false,
                ticks: {
                    beginAtZero: false
                }
            }
    }
		});
	
	var overallPrediction = overallPredictionPercentage;
	var elem = document.getElementById("overallDiscription");
	
	if (overallPrediction[0] + overallPrediction[1] <= 30 ){
		
		elem.style.color = "Green";
		document.getElementById("overallDiscription").innerHTML = "You are Safe!";
		
	}else if( overallPrediction[0] + overallPrediction[1] >=70 ){
		
		elem.style.color = "Red";
		document.getElementById("overallDiscription").innerHTML = "you're in Danger!";
	}else{
		
		elem.style.color = "Yellow";
		document.getElementById("overallDiscription").innerHTML = "Please be cautious...";
	}
	
	var myDoughnutChart = new Chart(document.getElementById("overallDanger").getContext("2d"), {
    type: 'doughnut',
    data: {
    labels: [
        "Danger Level",
        "confidence Inteval range",
        "safe"
    ],
    datasets: [
        {
            data: overallPredictionPercentage,
            backgroundColor: [
                "#FF6384",
                "#36A2EB",
                "#008000"
            ],
            hoverBackgroundColor: [
                "#FF6384",
                "#36A2EB",
                "#FFCE56"
            ]
        }]
},
    options: {}
});

//hiding 95% CI as default
myDoughnutChart.getDatasetMeta(0).data[1].hidden = true;
myDoughnutChart.update();

//baseline percentage of all parameters contribution
//it will be adjusted in iteration 3
var myEvidence = new Chart(document.getElementById("predictionEvidence").getContext("2d"), {
    data: {
    datasets: [{
        data: finalPercentage,
        backgroundColor: [
            "#FF6384",
            "#4BC0C0",
            "#FFCE56",
            "#E7E9ED",
            "#36A2EB"
        ],
        label: 'My dataset' // for legend
    }],
    labels: ['Humidity', 'Pressure', 'Temp', 'Wind',"Biodiversity"]
},
    type: 'polarArea',
    options: {}
});	

    			}
  			};
  			xhttp.open("GET", "https://query.yahooapis.com/v1/public/yql?q=select+*+from+weather.forecast+where+woeid+in+%28select+woeid+from+geo.places%281%29+where+text%3D%22Melbourne%2C+Australia%22%29&format=json", true);
  			xhttp.send();
	
	
</script>
</html>
